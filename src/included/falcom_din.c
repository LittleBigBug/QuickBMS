/*
Falcom din decompression 0.1
by Luigi Auriemma
e-mail: aluigi@autistici.org
web:    aluigi.org
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#ifdef WIN32
    #include <windows.h>
#endif



typedef struct {
    unsigned char   *decompressed_buffer;
    unsigned char   *compressed_buffer;
    int             decompressed_bytes;
    int             compressed_size;
} falcom_din_t;



static unsigned char falcom_din0_dump[] =
"\x83\xec\x10\x53\x55\x8b\x6c\x24\x1c\x56\x57\xbf\x04\x00\x00\x00\x8b\x45\x04\x89\x7c\x24\x10\xb2\x08\x66\x0f\xb6\x48\x01\x83\xc0"
"\x02\x66\x89\x4c\x24\x24\x89\x45\x04\x84\xd2\x75\x1a\x8b\x45\x04\x66\x8b\x10\x83\xc0\x02\x83\xc7\x02\x66\x89\x54\x24\x24\xb2\x10"
"\x89\x45\x04\x89\x7c\x24\x10\x8a\x44\x24\x24\x66\xd1\x6c\x24\x24\x83\xe0\x01\xfe\xca\x66\x85\xc0\x75\x26\x8b\x45\x04\x8b\x4d\x00"
"\x8a\x00\x88\x01\x8b\x5d\x00\x8b\x75\x04\x8b\x4d\x08\x43\x46\x41\x47\x89\x5d\x00\x89\x75\x04\x89\x4d\x08\x89\x7c\x24\x10\xeb\xa9"
"\x84\xd2\x75\x1a\x8b\x45\x04\xb2\x10\x66\x8b\x08\x83\xc0\x02\x83\xc7\x02\x66\x89\x4c\x24\x24\x89\x45\x04\x89\x7c\x24\x10\x8a\x44"
"\x24\x24\x66\xd1\x6c\x24\x24\x83\xe0\x01\xfe\xca\x66\x85\xc0\x75\x1a\x8b\x45\x04\x66\x0f\xb6\x08\x40\x47\x66\x89\x4c\x24\x14\x89"
"\x45\x04\x89\x7c\x24\x10\xe9\x78\x01\x00\x00\x33\xc9\xbe\x05\x00\x00\x00\xd1\xe1\x84\xd2\x75\x16\x8b\x45\x04\x66\x8b\x10\x83\xc0"
"\x02\x66\x89\x54\x24\x24\xb2\x10\x89\x45\x04\x83\xc7\x02\x8a\x44\x24\x24\x66\xd1\x6c\x24\x24\x83\xe0\x01\xfe\xca\x03\xc8\x4e\x75"
"\xd1\x8b\x45\x04\x89\x7c\x24\x10\xc1\xe1\x08\x66\x0f\xb6\x30\x03\xce\x40\x66\x83\xf9\x01\x89\x45\x04\x0f\x87\x20\x01\x00\x00\x0f"
"\x85\x30\x05\x00\x00\x84\xd2\x75\x13\x66\x8b\x08\x83\xc0\x02\x66\x89\x4c\x24\x24\xb2\x10\x89\x45\x04\x83\xc7\x02\x8a\x44\x24\x24"
"\x66\xd1\x6c\x24\x24\x83\xe0\x01\xfe\xca\x66\x85\xc0\x75\x3e\x33\xc9\xbe\x04\x00\x00\x00\xd1\xe1\x84\xd2\x75\x16\x8b\x45\x04\x66"
"\x8b\x10\x83\xc0\x02\x66\x89\x54\x24\x24\xb2\x10\x89\x45\x04\x83\xc7\x02\x8a\x44\x24\x24\x66\xd1\x6c\x24\x24\x83\xe0\x01\xfe\xca"
"\x03\xc8\x4e\x75\xd1\x8b\xc1\x8d\x4c\x0f\x0f\xeb\x4c\x33\xc9\xbe\x04\x00\x00\x00\xd1\xe1\x84\xd2\x75\x16\x8b\x45\x04\x66\x8b\x10"
"\x83\xc0\x02\x66\x89\x54\x24\x24\xb2\x10\x89\x45\x04\x83\xc7\x02\x8a\x44\x24\x24\x66\xd1\x6c\x24\x24\x83\xe0\x01\xfe\xca\x03\xc8"
"\x4e\x75\xd1\x8b\x75\x04\xc1\xe1\x08\x66\x0f\xb6\x06\x03\xc8\x46\x8b\xc1\x89\x75\x04\x8d\x4c\x07\x10\x8b\x75\x04\x89\x4c\x24\x10"
"\x25\xff\xff\x00\x00\x8b\x7d\x00\x8a\x0e\x89\x44\x24\x14\x88\x4c\x24\x18\x8d\x48\x0e\x8b\x44\x24\x18\x46\x25\xff\x00\x00\x00\x89"
"\x75\x04\x8a\xd8\x8b\xf1\x8a\xfb\x8b\xc3\xc1\xe0\x10\x66\x8b\xc3\xc1\xe9\x02\xf3\xab\x8b\xce\x83\xe1\x03\xf3\xaa\x8b\x44\x24\x14"
"\x8b\x75\x00\x8b\x7c\x24\x10\x8d\x48\x0e\x83\xc0\x0e\x03\xf1\x8b\x4d\x08\x03\xc8\x89\x75\x00\x89\x4d\x08\xe9\xea\xfd\xff\xff\x89"
"\x4c\x24\x14\x8b\x5d\x00\x8b\x4c\x24\x14\x81\xe1\xff\xff\x00\x00\x8b\xf3\x2b\xf1\x89\x5c\x24\x1c\x84\xd2\x75\x17\x66\x8b\x10\x83"
"\xc0\x02\x83\xc7\x02\x66\x89\x54\x24\x24\xb2\x10\x89\x45\x04\x89\x7c\x24\x10\x8a\x44\x24\x24\x66\xd1\x6c\x24\x24\x83\xe0\x01\xfe"
"\xca\x66\x85\xc0\x74\x43\xb8\x02\x00\x00\x00\x66\x39\x44\x24\x14\x72\x1c\x66\x8b\x0e\x66\x89\x0b\x8b\x4d\x00\x03\xc8\x8b\x45\x08"
"\x83\xc0\x02\x89\x4d\x00\x89\x45\x08\xe9\x7b\xfd\xff\xff\x8b\x4d\x00\x8a\x1e\x88\x19\x8b\x4d\x00\x41\x46\x48\x89\x4d\x00\x75\xee"
"\x83\x45\x08\x02\xe9\x60\xfd\xff\xff\x84\xd2\x75\x1a\x8b\x45\x04\x66\x8b\x10\x83\xc0\x02\x83\xc7\x02\x66\x89\x54\x24\x24\xb2\x10"
"\x89\x45\x04\x89\x7c\x24\x10\x8a\x44\x24\x24\x66\xd1\x6c\x24\x24\x83\xe0\x01\xfe\xca\x66\x85\xc0\x74\x4e\x66\x83\x7c\x24\x14\x02"
"\x72\x26\x66\x8b\x06\x66\x89\x03\x8b\x4d\x00\x8a\x46\x02\x88\x41\x02\x8b\x45\x00\x83\xc0\x03\x89\x45\x00\x8b\x45\x08\x83\xc0\x03"
"\x89\x45\x08\xe9\x01\xfd\xff\xff\xb8\x03\x00\x00\x00\x8b\x4d\x00\x8a\x1e\x88\x19\x8b\x4d\x00\x41\x46\x48\x89\x4d\x00\x75\xee\x83"
"\x45\x08\x03\xe9\xe1\xfc\xff\xff\x84\xd2\x75\x1a\x8b\x45\x04\x66\x8b\x10\x83\xc0\x02\x83\xc7\x02\x66\x89\x54\x24\x24\xb2\x10\x89"
"\x45\x04\x89\x7c\x24\x10\x8a\x44\x24\x24\x66\xd1\x6c\x24\x24\x83\xe0\x01\xfe\xca\x66\x85\xc0\x74\x41\xb8\x04\x00\x00\x00\x66\x39"
"\x44\x24\x14\x72\x1a\x8b\x0e\x89\x0b\x8b\x4d\x00\x03\xc8\x8b\x45\x08\x83\xc0\x04\x89\x4d\x00\x89\x45\x08\xe9\x8a\xfc\xff\xff\x8b"
"\x4d\x00\x8a\x1e\x88\x19\x8b\x4d\x00\x41\x46\x48\x89\x4d\x00\x75\xee\x83\x45\x08\x04\xe9\x6f\xfc\xff\xff\x84\xd2\x75\x1a\x8b\x45"
"\x04\x66\x8b\x10\x83\xc0\x02\x83\xc7\x02\x66\x89\x54\x24\x24\xb2\x10\x89\x45\x04\x89\x7c\x24\x10\x8a\x44\x24\x24\x66\xd1\x6c\x24"
"\x24\x83\xe0\x01\xfe\xca\x66\x85\xc0\x74\x4a\xb8\x05\x00\x00\x00\x66\x39\x44\x24\x14\x72\x23\x8b\x0e\x89\x0b\x8b\x4d\x00\x8a\x5e"
"\x04\x88\x59\x04\x8b\x4d\x00\x03\xc8\x8b\x45\x08\x83\xc0\x05\x89\x4d\x00\x89\x45\x08\xe9\x0f\xfc\xff\xff\x8b\x4d\x00\x8a\x1e\x88"
"\x19\x8b\x4d\x00\x41\x46\x48\x89\x4d\x00\x75\xee\x83\x45\x08\x05\xe9\xf4\xfb\xff\xff\x84\xd2\x75\x1a\x8b\x45\x04\x66\x8b\x10\x83"
"\xc0\x02\x83\xc7\x02\x66\x89\x54\x24\x24\xb2\x10\x89\x45\x04\x89\x7c\x24\x10\x8a\x44\x24\x24\x66\xd1\x6c\x24\x24\x83\xe0\x01\xfe"
"\xca\x66\x85\xc0\x0f\x85\xd0\x00\x00\x00\x8b\x4d\x04\x66\x0f\xb6\x01\x41\x83\xc0\x0e\x47\x66\x39\x44\x24\x14\x89\x4d\x04\x89\x7c"
"\x24\x10\x72\x0e\x25\xff\xff\x00\x00\x8b\xfb\x8b\xc8\xe9\x04\x01\x00\x00\x66\x83\x7c\x24\x14\x04\x72\x79\x25\xff\xff\x00\x00\x8b"
"\xc8\xc1\xe9\x04\x8b\xd9\x49\x85\xdb\x76\x36\x41\x8b\x7d\x00\x8b\x1e\x83\xc6\x10\x89\x1f\x8b\x7d\x00\x8b\x5e\xf4\x89\x5f\x04\x8b"
"\x7d\x00\x8b\x5e\xf8\x89\x5f\x08\x8b\x7d\x00\x8b\x5e\xfc\x89\x5f\x0c\x8b\x7d\x00\x83\xc7\x10\x49\x89\x7d\x00\x75\xcf\x8b\x7c\x24"
"\x10\x8b\xc8\x83\xe1\x0f\x8b\xd9\x49\x85\xdb\x76\x45\x8d\x79\x01\x8b\x4d\x00\x8a\x1e\x88\x19\x8b\x4d\x00\x41\x46\x4f\x89\x4d\x00"
"\x75\xee\x8b\x4d\x08\x8b\x7c\x24\x10\x03\xc8\x89\x4d\x08\xe9\x16\xfb\xff\xff\x25\xff\xff\x00\x00\x76\x18\x8b\xf8\x8b\x4d\x00\x8a"
"\x1e\x88\x19\x8b\x4d\x00\x41\x46\x4f\x89\x4d\x00\x75\xee\x8b\x7c\x24\x10\x01\x45\x08\xe9\xef\xfa\xff\xff\x33\xc9\xc7\x44\x24\x10"
"\x03\x00\x00\x00\xd1\xe1\x84\xd2\x75\x16\x8b\x45\x04\x66\x8b\x10\x83\xc0\x02\x66\x89\x54\x24\x24\xb2\x10\x89\x45\x04\x83\xc7\x02"
"\x8a\x44\x24\x24\x66\xd1\x6c\x24\x24\x83\xe0\x01\xfe\xca\x03\xc8\x8b\x44\x24\x10\x48\x89\x44\x24\x10\x75\xc9\x8d\x41\x06\x8b\x4c"
"\x24\x14\x66\x3b\xc8\x89\x7c\x24\x10\x72\x32\x8b\x7c\x24\x1c\x25\xff\xff\x00\x00\x8b\xc8\x8b\xd9\xc1\xe9\x02\xf3\xa5\x8b\xcb\x83"
"\xe1\x03\xf3\xa4\x8b\x4d\x00\x8b\x7c\x24\x10\x03\xc8\x89\x4d\x00\x8b\x4d\x08\x03\xc8\x89\x4d\x08\xe9\x6c\xfa\xff\xff\x66\x83\xf9"
"\x04\x72\x62\x25\xff\xff\x00\x00\x8b\xc8\xc1\xe9\x02\x8b\xd9\x49\x85\xdb\x76\x1b\x41\x8b\x7d\x00\x8b\x1e\x83\xc6\x04\x89\x1f\x8b"
"\x7d\x00\x83\xc7\x04\x49\x89\x7d\x00\x75\xea\x8b\x7c\x24\x10\x8b\xc8\x83\xe1\x03\x8b\xd9\x49\x85\xdb\x0f\x86\x33\xff\xff\xff\x8d"
"\x79\x01\x8b\x4d\x00\x8a\x1e\x88\x19\x8b\x4d\x00\x41\x46\x4f\x89\x4d\x00\x75\xee\x8b\x4d\x08\x8b\x7c\x24\x10\x03\xc8\x89\x4d\x08"
"\xe9\x04\xfa\xff\xff\x25\xff\xff\x00\x00\x0f\x86\x02\xff\xff\xff\x8b\xf8\x8b\x4d\x00\x8a\x1e\x88\x19\x8b\x4d\x00\x41\x46\x4f\x89"
"\x4d\x00\x75\xee\x8b\x4d\x08\x8b\x7c\x24\x10\x03\xc8\x89\x4d\x08\xe9\xd4\xf9\xff\xff\x5f\x5e\x5d\x5b\x83\xc4\x10\xc3"
;
static unsigned char falcom_dinX_dump[] =
"\x83\xec\x08\x53\x55\x8b\x6c\x24\x14\x56\x57\xbb\x02\x00\x00\x00\x66\x39\x5d\x0c\x0f\x84\xa3\x02\x00\x00\x8b\x75\x04\x8a\x06\x46"
"\x43\x89\x75\x04\xa8\x80\x0f\x84\x26\x01\x00\x00\x66\x0f\xb6\x16\x8a\xc8\x80\xe1\x1f\x66\x0f\xb6\xc9\xc1\xe1\x08\x03\xca\x8d\x56"
"\x01\x8b\x75\x00\x8b\xf9\x81\xe7\xff\xff\x00\x00\x89\x55\x04\xc1\xe8\x05\x2b\xf7\x83\xe0\x03\x43\x83\xc0\x04\x66\x39\x5d\x0c\x89"
"\x44\x24\x1c\x74\x29\x8a\x12\x8a\xc2\x24\xe0\x3c\x60\x75\x1f\x8b\x44\x24\x1c\x83\xe2\x1f\x03\xc2\x89\x44\x24\x1c\x8b\x45\x04\x40"
"\x43\x89\x45\x04\x8a\x10\x8a\xc2\x24\xe0\x3c\x60\x74\xe1\x8b\x44\x24\x1c\x8b\x55\x08\x03\xd0\x3b\xf8\x89\x55\x08\x72\x1b\x8b\x7d"
"\x00\x8b\xc8\x8b\xd1\xc1\xe9\x02\xf3\xa5\x8b\xca\x83\xe1\x03\xf3\xa4\x01\x45\x00\xe9\x8a\x00\x00\x00\x66\x83\xf9\x04\x72\x6e\x99"
"\x83\xe2\x0f\x03\xc2\xc1\xf8\x04\x8b\xc8\x48\x85\xc9\x7e\x32\x40\x8b\x55\x00\x8b\x0e\x83\xc6\x10\x89\x0a\x8b\x55\x00\x8b\x4e\xf4"
"\x89\x4a\x04\x8b\x55\x00\x8b\x4e\xf8\x89\x4a\x08\x8b\x55\x00\x8b\x4e\xfc\x89\x4a\x0c\x8b\x7d\x00\x83\xc7\x10\x48\x89\x7d\x00\x75"
"\xcf\x8b\x44\x24\x1c\x25\x0f\x00\x00\x80\x79\x05\x48\x83\xc8\xf0\x40\x8b\xd0\x48\x85\xd2\x7e\x2b\x40\x8b\x4d\x00\x8a\x16\x88\x11"
"\x8b\x7d\x00\x47\x46\x48\x89\x7d\x00\x75\xee\xeb\x16\x85\xc0\x7e\x12\x8b\x4d\x00\x8a\x16\x88\x11\x8b\x7d\x00\x47\x46\x48\x89\x7d"
"\x00\x75\xee\x66\x39\x5d\x0c\x0f\x84\x70\x01\x00\x00\xe9\xbe\xfe\xff\xff\xa8\x40\x0f\x84\xcb\x00\x00\x00\xa8\x10\x74\x69\x66\x0f"
"\xb6\x0e\x24\x0f\x8b\x7d\x08\x66\x0f\xb6\xc0\xc1\xe0\x08\x46\x83\xc3\x02\x89\x75\x04\x8d\x4c\x08\x04\x8a\x16\x46\x88\x54\x24\x10"
"\x81\xe1\xff\xff\x00\x00\x8b\x44\x24\x10\x89\x75\x04\x25\xff\x00\x00\x00\x89\x4c\x24\x1c\x8a\xd0\x03\xf9\x8a\xf2\x8b\xf1\x8b\xc2"
"\x89\x7d\x08\x8b\x7d\x00\xc1\xe0\x10\x66\x8b\xc2\xc1\xe9\x02\xf3\xab\x8b\xce\x83\xe1\x03\xf3\xaa\x8b\x4d\x00\x8b\xc6\x03\xc8\x89"
"\x4d\x00\xe9\x49\xfe\xff\xff\x8a\x0e\x24\x0f\x04\x04\x88\x4c\x24\x14\x88\x44\x24\x10\x8b\x44\x24\x14\x8b\x4c\x24\x10\x8b\x7d\x08"
"\x25\xff\x00\x00\x00\x46\x8a\xd0\x81\xe1\xff\x00\x00\x00\x8a\xf2\x89\x75\x04\x8b\xc2\x89\x4c\x24\x1c\x03\xf9\x8b\xf1\xc1\xe0\x10"
"\x89\x7d\x08\x8b\x7d\x00\x66\x8b\xc2\x43\xc1\xe9\x02\xf3\xab\x8b\xce\x83\xe1\x03\xf3\xaa\x8b\x4d\x00\x8b\xc6\x03\xc8\x89\x4d\x00"
"\xe9\xeb\xfd\xff\xff\x8a\xc8\x80\xe1\x1f\xa8\x20\x88\x4c\x24\x10\x74\x4b\x66\x33\xc0\x8b\x7d\x08\x8a\xc1\x66\x0f\xb6\x0e\xc1\xe0"
"\x08\x03\xc1\x46\x89\x75\x04\x8d\x5c\x03\x01\x25\xff\xff\x00\x00\x8b\xc8\x03\xf8\x8b\xd1\x89\x7d\x08\x8b\x7d\x00\xc1\xe9\x02\xf3"
"\xa5\x8b\xca\x83\xe1\x03\xf3\xa4\x8b\x55\x00\x8b\x4d\x04\x03\xd0\x03\xc8\x89\x55\x00\x89\x4d\x04\xe9\x93\xfd\xff\xff\x66\x33\xc0"
"\x8b\x7d\x08\x8a\xc1\x03\xd8\x8b\x44\x24\x10\x25\xff\x00\x00\x00\x8b\xc8\x03\xf8\x8b\xd1\x89\x7d\x08\x8b\x7d\x00\xc1\xe9\x02\xf3"
"\xa5\x8b\xca\x83\xe1\x03\xf3\xa4\x8b\x55\x00\x8b\x4d\x04\x03\xd0\x03\xc8\x89\x55\x00\x89\x4d\x04\xe9\x53\xfd\xff\xff\x5f\x5e\x5d"
"\x5b\x83\xc4\x08\xc3"
;

void __cdecl (*falcom_din0)(falcom_din_t *x) = NULL;
void __cdecl (*falcom_dinX)(falcom_din_t *x) = NULL;



// anti DEP limitation! if you apply VirtualAlloc on a static char
// it will cover also the rest of the page included other variables!
void *falcom_din_alloc(unsigned char *dump, int dumpsz) {
    int     pagesz;
    void    *ret;

    pagesz = (dumpsz + 4095) & (~4095); // useful for pages? mah

#ifdef WIN32
    ret = VirtualAlloc(
        NULL,
        pagesz,
        MEM_COMMIT | MEM_RESERVE,
        PAGE_EXECUTE_READWRITE);    // write for memcpy
#else
    ret = malloc(pagesz);
    mprotect(
        ret,
        pagesz,
        PROT_EXEC | PROT_WRITE);    // write for memcpy
#endif
    memcpy(ret, dump, dumpsz);
    return(ret);
}



int falcom_din(unsigned char *in, int insz, unsigned char *out, int flags) {
    falcom_din_t    t;
    int     ret     = 0;
    int     in_pos  = 0;
    int     chunk_size; // do not use 16bit because it's multi-purpose

    if(!falcom_din0) falcom_din0 = (void *)falcom_din_alloc(falcom_din0_dump, sizeof(falcom_din0_dump));
    if(!falcom_dinX) falcom_dinX = (void *)falcom_din_alloc(falcom_dinX_dump, sizeof(falcom_dinX_dump));

    /*
    flags:
    0 = full chunks handling: input file -> output file
    1 = single chunk: input chunk -> output chunk
    2 = func0
    3 = funcX
    */

    while(in_pos < insz) {
        if(!flags) {
            chunk_size = in[in_pos] | (in[in_pos+1] << 8);
            in_pos += 2;
        } else {
            chunk_size = insz;
        }

        t.decompressed_buffer   = out + ret;
        t.compressed_buffer     = in  + in_pos;
        t.decompressed_bytes    = 0;
        t.compressed_size       = chunk_size;

        if(flags == 2) {
            t.compressed_buffer--;
            t.compressed_size--;
            falcom_din0(&t);

        } else if(flags == 3) {
            falcom_dinX(&t);

        } else {
            if(!t.compressed_buffer[0]) {
                falcom_din0(&t);
            } else {
                falcom_dinX(&t);
            }
        }

        if(!flags) chunk_size--;
        in_pos += chunk_size;

        ret    += t.decompressed_bytes;

        if(flags) break;
    }

    return ret;
}


